<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management | INFI X TECH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/styles.css">
</head>

<body>
    <div class="app-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="header-container"></div>
            <div class="page-content">
                <div id="loadingState" class="text-center py-4">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <p class="text-muted">Loading events...</p>
                </div>

                <div id="pageContent" style="display: none;">
                    <!-- Banner -->
                    <div class="card mb-lg"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none;">
                        <div class="card-body"
                            style="padding: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem;">Event
                                    Management üèÜ</h1>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Create, manage, and track all team events
                                    with detailed logging.</p>
                            </div>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                onclick="showCreateEventModal()" id="createEventBtn">+ Create Event</button>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div
                        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon primary">üìÖ</div>
                                <div>
                                    <div class="stat-value" id="totalEvents">0</div>
                                    <div class="stat-label">Total Events</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon warning">‚è≥</div>
                                <div>
                                    <div class="stat-value" id="upcomingEvents">0</div>
                                    <div class="stat-label">Upcoming</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon info">üîÑ</div>
                                <div>
                                    <div class="stat-value" id="activeEvents">0</div>
                                    <div class="stat-label">Active</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon success">‚úì</div>
                                <div>
                                    <div class="stat-value" id="completedEvents">0</div>
                                    <div class="stat-label">Completed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-lg">
                        <div class="card-body" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <input type="text" class="form-input" placeholder="üîç Search events..." id="searchInput"
                                style="flex: 1; min-width: 200px;">
                            <select class="form-input" id="filterStatus" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <select class="form-input" id="filterType" style="width: 150px;">
                                <option value="">All Types</option>
                                <option value="hackathon">Hackathon</option>
                                <option value="workshop">Workshop</option>
                                <option value="meetup">Meetup</option>
                                <option value="competition">Competition</option>
                                <option value="training">Training</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Events Grid -->
                    <div id="eventsGrid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                        <p class="text-muted text-center py-4">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/firestore.js"></script>
    <script src="../../js/components.js"></script>
    <script src="../../js/notifications.js"></script>
    <script src="../../js/router.js"></script>
    <script src="../../js/app.js"></script>

    <script>
        let allEvents = [];
        let allMembers = [];
        let isLeader = false;

        window.addEventListener('userDataLoaded', async (e) => {
            const user = e.detail;
            isLeader = user.roles?.includes('leader');

            // Only leaders can access event management
            if (!isLeader) {
                Utils.showToast('Access denied. Only Leaders can manage events.', 'error');
                setTimeout(() => window.history.back(), 1500);
                return;
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('pageContent').style.display = 'block';

            await loadEvents();
        });

        async function loadEvents() {
            try {
                // Fetch all and sort client-side to avoid composite index requirements
                const [eventsSnap, usersSnap] = await Promise.all([
                    db.collection('events').get(),
                    db.collection('users').get()
                ]);

                allEvents = eventsSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => {
                        const aDate = a.createdAt?.toDate?.() || new Date(0);
                        const bDate = b.createdAt?.toDate?.() || new Date(0);
                        return bDate - aDate;
                    });
                allMembers = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Stats
                const upcoming = allEvents.filter(e => e.status === 'upcoming').length;
                const active = allEvents.filter(e => e.status === 'active').length;
                const completed = allEvents.filter(e => e.status === 'completed').length;

                document.getElementById('totalEvents').textContent = allEvents.length;
                document.getElementById('upcomingEvents').textContent = upcoming;
                document.getElementById('activeEvents').textContent = active;
                document.getElementById('completedEvents').textContent = completed;

                renderEvents(allEvents);
            } catch (error) {
                console.error('Error:', error);
                Utils.showToast('Error loading events', 'error');
            }
        }

        function renderEvents(events) {
            const grid = document.getElementById('eventsGrid');

            if (events.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèÜ</div>
                        <h3>No Events Found</h3>
                        <p class="text-muted">Create your first event to get started!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = events.map(event => {
                const statusColors = {
                    upcoming: 'var(--warning-500)',
                    active: 'var(--info-500)',
                    completed: 'var(--success-500)',
                    cancelled: 'var(--text-muted)'
                };
                const statusColor = statusColors[event.status] || 'var(--primary-500)';
                const participantCount = event.participants?.length || 0;
                const logCount = event.logs?.length || 0;

                return `
                    <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="viewEvent('${event.id}')" onmouseenter="this.style.transform='translateY(-4px)'" onmouseleave="this.style.transform='translateY(0)'">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; background: ${statusColor}; color: white; text-transform: capitalize;">
                                    ${event.status || 'upcoming'}
                                </span>
                                <span style="font-size: 0.8rem; color: var(--text-muted);">${event.type || 'Event'}</span>
                            </div>
                            
                            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">${event.name || 'Untitled Event'}</h3>
                            <p class="text-muted text-sm" style="margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${event.description || 'No description provided.'}
                            </p>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìÖ</span>
                                    <span class="text-sm">${event.startDate ? Utils.formatDate(event.startDate) : 'TBD'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìç</span>
                                    <span class="text-sm">${event.venue || 'TBD'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üë•</span>
                                    <span class="text-sm">${participantCount} Participants</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìù</span>
                                    <span class="text-sm">${logCount} Logs</span>
                                </div>
                            </div>

                            ${event.budget ? `
                                <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span class="text-muted text-sm">Budget</span>
                                        <span class="font-bold">${Utils.formatCurrency(event.budget)}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filters
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterType').addEventListener('change', applyFilters);

        function applyFilters() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;

            let filtered = allEvents;

            if (query) {
                filtered = filtered.filter(e =>
                    (e.name || '').toLowerCase().includes(query) ||
                    (e.description || '').toLowerCase().includes(query) ||
                    (e.venue || '').toLowerCase().includes(query)
                );
            }

            if (status) filtered = filtered.filter(e => e.status === status);
            if (type) filtered = filtered.filter(e => e.type === type);

            renderEvents(filtered);
        }

        function showCreateEventModal() {
            const memberCheckboxes = allMembers.filter(m => m.isActive !== false).map(m => `
                <label style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg-glass); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" name="eventParticipants" value="${m.id}" data-name="${m.name || m.email}">
                    ${m.name || m.email}
                </label>
            `).join('');

            Modal.show({
                title: 'Create New Event',
                size: 'large',
                content: `
                    <form id="eventForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Event Name *</label>
                                <input type="text" class="form-input" id="eventName" required placeholder="e.g., Hackathon 2025">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Event Type *</label>
                                <select class="form-input" id="eventType" required>
                                    <option value="hackathon">Hackathon</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="meetup">Meetup</option>
                                    <option value="competition">Competition</option>
                                    <option value="training">Training</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-input" id="eventStartDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-input" id="eventEndDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Venue</label>
                                <input type="text" class="form-input" id="eventVenue" placeholder="e.g., Conference Hall A">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Budget (‚Çπ)</label>
                                <input type="number" class="form-input" id="eventBudget" placeholder="0" min="0">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="eventDescription" rows="3" placeholder="Event details, objectives, etc."></textarea>
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label class="form-label" style="margin: 0;">Assign Participants</label>
                                <button type="button" class="btn btn-ghost btn-sm" onclick="toggleAllEventParticipants()">Toggle All</button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: var(--bg-glass); border-radius: 8px;">
                                ${memberCheckboxes}
                            </div>
                        </div>
                    </form>
                `,
                submitText: 'Create Event',
                onSubmit: createEvent
            });
        }

        function toggleAllEventParticipants() {
            const checkboxes = document.querySelectorAll('input[name="eventParticipants"]');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        async function createEvent() {
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('eventType').value;
            const startDate = document.getElementById('eventStartDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const venue = document.getElementById('eventVenue').value.trim();
            const budget = Number(document.getElementById('eventBudget').value) || 0;
            const description = document.getElementById('eventDescription').value.trim();

            const participantInputs = document.querySelectorAll('input[name="eventParticipants"]:checked');
            const participants = Array.from(participantInputs).map(input => ({
                userId: input.value,
                userName: input.dataset.name,
                role: 'participant',
                addedAt: new Date()
            }));

            if (!name || !startDate) {
                Utils.showToast('Please fill required fields', 'error');
                return;
            }

            try {
                await db.collection('events').add({
                    name,
                    type,
                    startDate: new Date(startDate),
                    endDate: endDate ? new Date(endDate) : null,
                    venue,
                    budget,
                    description,
                    participants,
                    logs: [],
                    expenses: [],
                    status: 'upcoming',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: Auth.userData?.uid
                });

                Utils.showToast('Event created successfully!', 'success');
                Modal.close();
                loadEvents();
            } catch (error) {
                Utils.showToast('Error: ' + error.message, 'error');
            }
        }

        function viewEvent(eventId) {
            window.location.href = `event-details.html?id=${eventId}`;
        }

        Router.initPage();
    </script>
</body>

</html>