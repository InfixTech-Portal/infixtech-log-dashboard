<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Logs | INFI X TECH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/styles.css">
</head>

<body>
    <div class="app-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="header-container"></div>
            <div class="page-content">
                <div id="loadingState" class="text-center py-4">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <p class="text-muted">Loading payments...</p>
                </div>

                <div id="pageContent" style="display: none;">
                    <!-- Banner -->
                    <div class="card mb-lg"
                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none;">
                        <div class="card-body" style="padding: 2rem;">
                            <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem;">Payment Logs üí∞
                            </h1>
                            <p style="opacity: 0.9; font-size: 0.9rem;">View your pending payments and submit payment
                                proof.</p>
                        </div>
                    </div>

                    <!-- My Outstanding -->
                    <div class="card mb-lg" id="outstandingCard">
                        <div class="card-header">
                            <h3 class="card-title">My Pending Payments</h3>
                            <span class="text-danger font-bold" id="totalOutstanding">‚Çπ0</span>
                        </div>
                        <div class="card-body" id="myPendingPayments">
                            <p class="text-muted text-center py-4">Loading...</p>
                        </div>
                    </div>

                    <!-- Payment History -->
                    <div class="card mb-lg">
                        <div class="card-header">
                            <h3 class="card-title">My Payment History</h3>
                        </div>
                        <div class="card-body" id="paymentHistory">
                            <p class="text-muted text-center py-4">Loading...</p>
                        </div>
                    </div>

                    <!-- Admin Section -->
                    <div id="adminSection" style="display: none;">
                        <div class="card mb-lg">
                            <div class="card-header">
                                <h3 class="card-title">Pending Verifications</h3>
                                <span class="text-warning" id="pendingCount">0 pending</span>
                            </div>
                            <div class="card-body" id="pendingVerifications">
                                <p class="text-muted text-center py-4">Loading...</p>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">All Transactions</h3>
                                <a href="../admin/transactions.html" class="btn btn-secondary btn-sm">View All ‚Üí</a>
                            </div>
                            <div class="card-body" id="allTransactions">
                                <p class="text-muted text-center py-4">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/firestore.js"></script>
    <script src="../../js/components.js"></script>
    <script src="../../js/router.js"></script>
    <script src="../../js/app.js"></script>

    <script>
        let currentUser = null;
        let allCollections = [];
        let allTransactions = [];
        let isAdmin = false;

        window.addEventListener('userDataLoaded', async (e) => {
            currentUser = e.detail;
            isAdmin = currentUser.roles?.includes('leader') || currentUser.roles?.includes('finance');

            if (isAdmin) {
                document.getElementById('adminSection').style.display = 'block';
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('pageContent').style.display = 'block';

            await loadPaymentData();
        });

        async function loadPaymentData() {
            try {
                // Fetch all data without complex queries to avoid composite index requirements
                const [collectionsSnap, transactionsSnap] = await Promise.all([
                    db.collection('moneyCollections').get(),
                    db.collection('transactions').get()
                ]);

                allCollections = collectionsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Filter transactions for current user client-side
                allTransactions = transactionsSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(t => t.memberId === currentUser.uid)
                    .sort((a, b) => {
                        const aDate = a.date?.toDate?.() || new Date(0);
                        const bDate = b.date?.toDate?.() || new Date(0);
                        return bDate - aDate;
                    })
                    .slice(0, 20);

                // Sort collections by createdAt
                allCollections.sort((a, b) => {
                    const aDate = a.createdAt?.toDate?.() || new Date(0);
                    const bDate = b.createdAt?.toDate?.() || new Date(0);
                    return bDate - aDate;
                });

                renderMyPendingPayments();
                renderPaymentHistory();

                if (isAdmin) {
                    await loadAdminData();
                }
            } catch (error) {
                console.error('Error:', error);
                Utils.showToast('Error loading data', 'error');
            }
        }

        function renderMyPendingPayments() {
            const container = document.getElementById('myPendingPayments');
            let totalOutstanding = 0;
            const pendingItems = [];

            allCollections.forEach(collection => {
                const myEntry = collection.assignedMembers?.find(m => m.userId === currentUser.uid);
                if (myEntry && myEntry.status !== 'paid' && myEntry.status !== 'verified') {
                    totalOutstanding += (myEntry.amount || collection.amount || 0);
                    pendingItems.push({
                        collectionId: collection.id,
                        title: collection.title,
                        amount: myEntry.amount || collection.amount,
                        deadline: collection.deadline,
                        status: myEntry.status || 'pending',
                        utrNumber: myEntry.utrNumber
                    });
                }
            });

            document.getElementById('totalOutstanding').textContent = Utils.formatCurrency(totalOutstanding);

            if (totalOutstanding === 0) {
                document.getElementById('outstandingCard').style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent)';
                document.getElementById('totalOutstanding').className = 'text-success font-bold';
                document.getElementById('totalOutstanding').textContent = '‚úì All Clear!';
            }

            if (pendingItems.length === 0) {
                container.innerHTML = '<p class="text-success text-center py-4">üéâ You have no pending payments!</p>';
                return;
            }

            container.innerHTML = pendingItems.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.75rem; background: ${item.status === 'submitted' ? 'rgba(245, 158, 11, 0.1)' : 'var(--bg-glass)'}; border-radius: 12px; border-left: 4px solid ${item.status === 'submitted' ? 'var(--warning-500)' : 'var(--danger-500)'};">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 1.1rem;">${item.title}</div>
                        <div class="text-sm text-muted">${item.deadline ? 'Due: ' + Utils.formatDate(item.deadline) : 'Pay ASAP'}</div>
                        ${item.status === 'submitted' ? `<div class="text-sm text-warning">‚è≥ UTR: ${item.utrNumber} - Awaiting verification</div>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger-500); margin-bottom: 0.5rem;">
                            ${Utils.formatCurrency(item.amount)}
                        </div>
                        ${item.status === 'submitted'
                    ? '<span style="padding: 4px 12px; background: var(--warning-500); color: white; border-radius: 20px; font-size: 0.75rem;">Submitted</span>'
                    : `<button class="btn btn-primary btn-sm" onclick="showPaymentModal('${item.collectionId}', '${item.title}', ${item.amount})">Pay Now</button>`
                }
                    </div>
                </div>
            `).join('');
        }

        function renderPaymentHistory() {
            const container = document.getElementById('paymentHistory');

            if (allTransactions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">No payment history yet</p>';
                return;
            }

            container.innerHTML = allTransactions.slice(0, 10).map(t => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--bg-glass-border);">
                    <div>
                        <div style="font-weight: 500;">${t.description || 'Payment'}</div>
                        <div class="text-xs text-muted">${t.date ? Utils.formatDate(t.date) : ''} ${t.utrNumber ? '‚Ä¢ UTR: ' + t.utrNumber : ''}</div>
                    </div>
                    <div style="text-align: right;">
                        <span style="font-weight: 600; color: ${t.type === 'credit' ? 'var(--success-500)' : 'var(--danger-500)'};">
                            ${t.type === 'credit' ? '+' : '-'}${Utils.formatCurrency(t.amount)}
                        </span>
                        ${t.status === 'verified' ? '<div class="text-xs text-success">‚úì Verified</div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadAdminData() {
            try {
                // Get all pending verifications
                const pendingItems = [];
                allCollections.forEach(collection => {
                    collection.assignedMembers?.forEach(m => {
                        if (m.status === 'submitted') {
                            pendingItems.push({
                                collectionId: collection.id,
                                collectionTitle: collection.title,
                                userId: m.userId,
                                userName: m.userName,
                                amount: m.amount || collection.amount,
                                utrNumber: m.utrNumber,
                                submittedAt: m.submittedAt
                            });
                        }
                    });
                });

                document.getElementById('pendingCount').textContent = `${pendingItems.length} pending`;

                const container = document.getElementById('pendingVerifications');
                if (pendingItems.length === 0) {
                    container.innerHTML = '<p class="text-success text-center py-4">‚úì No pending verifications</p>';
                } else {
                    container.innerHTML = pendingItems.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border-left: 4px solid var(--warning-500);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${item.userName || 'Unknown'}</div>
                                <div class="text-sm">${item.collectionTitle}</div>
                                <div class="text-sm text-muted">UTR: <strong>${item.utrNumber}</strong></div>
                                <div class="text-xs text-muted">${item.submittedAt ? Utils.timeAgo(item.submittedAt) : ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;">${Utils.formatCurrency(item.amount)}</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success btn-sm" onclick="verifyPayment('${item.collectionId}', '${item.userId}', ${item.amount}, '${item.utrNumber}', '${item.collectionTitle}')">‚úì Verify</button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectPayment('${item.collectionId}', '${item.userId}')">‚úó Reject</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Recent transactions
                const allTxSnap = await db.collection('transactions').orderBy('date', 'desc').limit(10).get();
                const allTx = allTxSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                document.getElementById('allTransactions').innerHTML = allTx.map(t => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--bg-glass-border);">
                        <div>
                            <div style="font-weight: 500;">${t.description || 'Transaction'}</div>
                            <div class="text-xs text-muted">${t.memberName || ''} ‚Ä¢ ${t.date ? Utils.formatDate(t.date) : ''}</div>
                        </div>
                        <span style="font-weight: 600; color: ${t.type === 'credit' ? 'var(--success-500)' : 'var(--danger-500)'};">
                            ${t.type === 'credit' ? '+' : '-'}${Utils.formatCurrency(t.amount)}
                        </span>
                    </div>
                `).join('') || '<p class="text-muted text-center py-4">No transactions yet</p>';

            } catch (error) {
                console.error('Admin data error:', error);
            }
        }

        function showPaymentModal(collectionId, title, amount) {
            Modal.show({
                title: 'Make Payment',
                size: 'medium',
                content: `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Amount to Pay</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-500);">${Utils.formatCurrency(amount)}</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">for ${title}</div>
                    </div>

                    <div style="background: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <img src="../../images/paymentqr.jpeg" alt="Payment QR Code" style="width: 100%; max-width: 250px; margin: 0 auto; display: block; border-radius: 8px;">
                    </div>

                    <div style="background: var(--bg-glass); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">üì± Payment Instructions</h4>
                        <ol style="margin: 0; padding-left: 1.25rem; color: var(--text-muted); font-size: 0.9rem;">
                            <li>Scan the QR code with any UPI app</li>
                            <li>Pay exactly <strong>${Utils.formatCurrency(amount)}</strong></li>
                            <li>Copy the UTR/Transaction number from payment confirmation</li>
                            <li>Enter the UTR number below and submit</li>
                        </ol>
                    </div>

                    <form id="paymentForm">
                        <div class="form-group">
                            <label class="form-label">UTR / Transaction Number *</label>
                            <input type="text" class="form-input" id="utrNumber" required placeholder="e.g., 423456789012" style="font-size: 1.1rem; letter-spacing: 1px;">
                            <div class="text-xs text-muted" style="margin-top: 0.25rem;">12-digit number from your payment confirmation</div>
                        </div>
                    </form>
                `,
                submitText: '‚úì Submit Payment Proof',
                onSubmit: () => submitPaymentProof(collectionId, amount, title)
            });
        }

        async function submitPaymentProof(collectionId, amount, title) {
            const utrNumber = document.getElementById('utrNumber').value.trim();

            if (!utrNumber) {
                Utils.showToast('Please enter the UTR number', 'error');
                return;
            }

            if (utrNumber.length < 10) {
                Utils.showToast('Please enter a valid UTR number', 'error');
                return;
            }

            try {
                // Update collection with UTR
                const collectionRef = db.collection('moneyCollections').doc(collectionId);
                const doc = await collectionRef.get();
                const collection = doc.data();

                const updatedMembers = collection.assignedMembers.map(m => {
                    if (m.userId === currentUser.uid) {
                        return {
                            ...m,
                            status: 'submitted',
                            utrNumber: utrNumber,
                            submittedAt: new Date()
                        };
                    }
                    return m;
                });

                await collectionRef.update({ assignedMembers: updatedMembers });

                Utils.showToast('Payment proof submitted! Awaiting verification.', 'success');
                Modal.close();
                loadPaymentData();
            } catch (error) {
                Utils.showToast('Error: ' + error.message, 'error');
            }
        }

        async function verifyPayment(collectionId, userId, amount, utrNumber, collectionTitle) {
            Modal.confirm(`Verify payment of ${Utils.formatCurrency(amount)} with UTR: ${utrNumber}?`, async () => {
                try {
                    // Update collection status
                    const collectionRef = db.collection('moneyCollections').doc(collectionId);
                    const doc = await collectionRef.get();
                    const collection = doc.data();

                    const member = collection.assignedMembers.find(m => m.userId === userId);

                    const updatedMembers = collection.assignedMembers.map(m => {
                        if (m.userId === userId) {
                            return {
                                ...m,
                                status: 'paid',
                                verifiedAt: new Date(),
                                verifiedBy: currentUser.uid
                            };
                        }
                        return m;
                    });

                    await collectionRef.update({ assignedMembers: updatedMembers });

                    // Create transaction record
                    await db.collection('transactions').add({
                        type: 'credit',
                        amount: amount,
                        date: new Date(),
                        category: 'collection',
                        memberId: userId,
                        memberName: member?.userName || 'Unknown',
                        description: `Payment for: ${collectionTitle}`,
                        utrNumber: utrNumber,
                        status: 'verified',
                        collectionId: collectionId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        verifiedBy: currentUser.uid
                    });

                    Utils.showToast('Payment verified and recorded!', 'success');
                    loadPaymentData();
                } catch (error) {
                    Utils.showToast('Error: ' + error.message, 'error');
                }
            });
        }

        async function rejectPayment(collectionId, userId) {
            Modal.confirm('Reject this payment submission? The member will need to resubmit.', async () => {
                try {
                    const collectionRef = db.collection('moneyCollections').doc(collectionId);
                    const doc = await collectionRef.get();
                    const collection = doc.data();

                    const updatedMembers = collection.assignedMembers.map(m => {
                        if (m.userId === userId) {
                            return {
                                ...m,
                                status: 'rejected',
                                rejectedAt: new Date(),
                                rejectedBy: currentUser.uid
                            };
                        }
                        return m;
                    });

                    await collectionRef.update({ assignedMembers: updatedMembers });

                    Utils.showToast('Payment rejected', 'success');
                    loadPaymentData();
                } catch (error) {
                    Utils.showToast('Error: ' + error.message, 'error');
                }
            });
        }

        Router.initPage();
    </script>
</body>

</html>