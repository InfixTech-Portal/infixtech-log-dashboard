<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Logs | INFI X TECH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/styles.css">
    <style>
        .priority-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-500);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-500);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-500);
        }

        .task-status-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-500);
        }

        .status-in-progress {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info-500);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-500);
        }

        .task-card {
            background: var(--bg-glass);
            border: 1px solid var(--bg-glass-border);
            border-radius: 12px;
            padding: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .task-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="header-container"></div>
            <div class="page-content">
                <div id="loadingState" class="text-center py-4">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <p class="text-muted">Loading tasks...</p>
                </div>

                <div id="pageContent" style="display: none;">
                    <!-- Banner -->
                    <div class="card mb-lg"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none;">
                        <div class="card-body"
                            style="padding: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h1 style="font-size: 1.75rem; font-weight: 700;">Task Management ‚úÖ</h1>
                                <p style="opacity: 0.9;">Track and manage all team tasks.</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="Reports.generateTaskReport()">üìÑ Export PDF</button>
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="createTask()" id="addTaskBtn">+ New Task</button>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Summary Dashboard -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;"
                        id="progressStats">
                        <div class="card" style="border-left: 4px solid var(--primary-500);">
                            <div class="card-body" style="padding: 1rem;">
                                <div class="text-muted text-sm">Total Tasks</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="totalTasks">0</div>
                            </div>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--success-500);">
                            <div class="card-body" style="padding: 1rem;">
                                <div class="text-muted text-sm">Completed</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--success-500);"
                                    id="completedTasks">0</div>
                            </div>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--info-500);">
                            <div class="card-body" style="padding: 1rem;">
                                <div class="text-muted text-sm">In Progress</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--info-500);"
                                    id="inProgressTasks">0</div>
                            </div>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--warning-500);">
                            <div class="card-body" style="padding: 1rem;">
                                <div class="text-muted text-sm">Pending</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--warning-500);"
                                    id="pendingTasks">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Overall Progress Bar -->
                    <div class="card mb-lg">
                        <div class="card-body">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-weight: 600;">üìä Overall Project Progress</span>
                                <span style="font-size: 1.25rem; font-weight: 700;" id="overallProgress">0%</span>
                            </div>
                            <div
                                style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
                                <div id="overallProgressBar"
                                    style="height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6); border-radius: 6px; transition: width 0.5s ease; width: 0%;">
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;"
                                class="text-xs text-muted">
                                <span id="progressDetails">0 of 0 tasks completed</span>
                                <span id="avgProgress">Avg progress: 0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-lg">
                        <div class="card-body" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <select class="form-input" id="filterStatus" style="max-width: 150px;">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                            <select class="form-input" id="filterPriority" style="max-width: 150px;">
                                <option value="">All Priority</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                            <input type="text" class="form-input" id="searchTasks" placeholder="Search tasks..."
                                style="max-width: 200px;">
                            <div style="flex: 1;"></div>
                            <span class="text-muted" id="taskCount">0 tasks</span>
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Tasks</h3>
                        </div>
                        <div class="card-body" id="taskList">
                            <p class="text-muted text-center py-4">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/firestore.js"></script>
    <script src="../../js/components.js"></script>
    <script src="../../js/reports.js"></script>
    <script src="../../js/notifications.js"></script>
    <script src="../../js/router.js"></script>
    <script src="../../js/app.js"></script>

    <script>
        let allTasks = [];
        let filteredTasks = [];
        let currentUser = null;

        window.addEventListener('userDataLoaded', async (e) => {
            currentUser = e.detail;

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('pageContent').style.display = 'block';

            // Hide add button for non-leaders
            if (!currentUser.roles?.includes('leader') && !currentUser.roles?.includes('admin')) {
                document.getElementById('addTaskBtn').style.display = 'none';
            }

            await loadTasks();
        });

        async function loadTasks() {
            try {
                // Fetch all logs and filter client-side to avoid composite index requirements
                const snapshot = await db.collection('logs').get();

                allTasks = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(log => log.type === 'task')
                    .sort((a, b) => {
                        const aDate = a.createdAt?.toDate?.() || new Date(0);
                        const bDate = b.createdAt?.toDate?.() || new Date(0);
                        return bDate - aDate;
                    });

                filteredTasks = [...allTasks];
                updateProgressStats();
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('taskList').innerHTML = '<p class="text-danger text-center py-4">Error loading tasks. Please refresh the page.</p>';
            }
        }

        function updateProgressStats() {
            const total = allTasks.length;
            const completed = allTasks.filter(t => t.data?.status === 'completed').length;
            const inProgress = allTasks.filter(t => t.data?.status === 'in-progress').length;
            const pending = allTasks.filter(t => t.data?.status === 'pending' || !t.data?.status).length;

            // Update stat cards
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('pendingTasks').textContent = pending;

            // Calculate overall progress
            let totalProgress = 0;
            allTasks.forEach(t => {
                if (t.data?.status === 'completed') {
                    totalProgress += 100;
                } else if (t.data?.progress) {
                    totalProgress += t.data.progress;
                }
            });

            const avgProgress = total > 0 ? Math.round(totalProgress / total) : 0;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

            // Update progress bar
            document.getElementById('overallProgress').textContent = `${completionRate}%`;
            document.getElementById('overallProgressBar').style.width = `${completionRate}%`;
            document.getElementById('progressDetails').textContent = `${completed} of ${total} tasks completed`;
            document.getElementById('avgProgress').textContent = `Avg progress: ${avgProgress}%`;
        }

        function renderTasks() {
            document.getElementById('taskCount').textContent = `${filteredTasks.length} tasks`;
            const list = document.getElementById('taskList');

            if (filteredTasks.length === 0) {
                list.innerHTML = '<p class="text-muted text-center py-4">No tasks found.</p>';
                return;
            }

            list.innerHTML = filteredTasks.map(t => {
                const data = t.data || {};
                const priority = data.priority || 'medium';
                const status = data.status || 'pending';

                return `
                    <div class="task-card" style="margin-bottom: 1rem; border-left: 4px solid var(--${priority === 'high' ? 'danger' : priority === 'low' ? 'success' : 'warning'}-500);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <span class="priority-badge priority-${priority}">${priority}</span>
                                    <span class="task-status-badge status-${status}">${status.replace('-', ' ')}</span>
                                </div>
                                <h4 style="font-weight: 600; margin-bottom: 0.25rem;">${data.title || 'Untitled Task'}</h4>
                                <p class="text-muted text-sm" style="margin-bottom: 0.5rem;">
                                    ${data.description ? Utils.truncate(data.description, 100) : 'No description'}
                                </p>
                                <div class="text-muted text-xs">
                                    üë§ ${data.assigneeName || 'Unassigned'} ‚Ä¢ ${Utils.timeAgo(t.createdAt)}
                                    ${data.dueDate ? ` ‚Ä¢ ‚è∞ Due ${Utils.formatDate(data.dueDate)}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-secondary btn-sm" onclick="toggleStatus('${t.id}', '${status}')">
                                    ${status === 'completed' ? '‚Ü©Ô∏è Reopen' : status === 'pending' ? '‚ñ∂Ô∏è Start' : '‚úÖ Complete'}
                                </button>
                                ${currentUser?.roles?.includes('leader') || currentUser?.roles?.includes('admin') ? `
                                    <button class="btn btn-ghost btn-sm" onclick="editTask('${t.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-ghost btn-sm" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
                                ` : ''}
                                ${status !== 'completed' ? `
                                    <button class="btn btn-ghost btn-sm" onclick="showUpdateProgressModal('${t.id}', ${data.progress || 0})" title="Update Progress">üìä</button>
                                ` : ''}
                            </div>
                        </div>
                        ${status !== 'completed' ? `
                            <div style="margin-top: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span class="text-xs text-muted">Progress</span>
                                    <span class="text-xs" style="color: ${(data.progress || 0) >= 70 ? 'var(--success-500)' : (data.progress || 0) >= 30 ? 'var(--warning-500)' : 'var(--text-muted)'};">${data.progress || 0}%</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill" style="width: ${data.progress || 0}%;"></div>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
                                <span class="text-success">‚úÖ Task Completed</span>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Filters
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterPriority').addEventListener('change', applyFilters);
        document.getElementById('searchTasks').addEventListener('input', applyFilters);

        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            const search = document.getElementById('searchTasks').value.toLowerCase();

            filteredTasks = allTasks.filter(t => {
                const data = t.data || {};
                if (status && data.status !== status) return false;
                if (priority && data.priority !== priority) return false;
                if (search && !data.title?.toLowerCase().includes(search) && !data.description?.toLowerCase().includes(search)) return false;
                return true;
            });

            renderTasks();
        }

        async function toggleStatus(taskId, currentStatus) {
            let newStatus;
            if (currentStatus === 'completed') {
                newStatus = 'pending';
            } else if (currentStatus === 'pending') {
                newStatus = 'in-progress';
            } else {
                newStatus = 'completed';
            }

            try {
                const updateData = {
                    'data.status': newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (newStatus === 'completed') {
                    updateData['data.completedAt'] = firebase.firestore.FieldValue.serverTimestamp();
                    updateData['data.progress'] = 100;
                }

                await db.collection('logs').doc(taskId).update(updateData);
                Utils.showToast(`Task marked as ${newStatus.replace('-', ' ')}`, 'success');
                await loadTasks();
                applyFilters();
            } catch (error) {
                Utils.showToast('Error updating task: ' + error.message, 'error');
            }
        }

        function showUpdateProgressModal(taskId, currentProgress) {
            Modal.show({
                title: 'üìä Update Task Progress',
                content: `
                    <div style="padding: 1rem 0;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem; font-weight: 700;" id="progressDisplay">${currentProgress}%</div>
                        </div>
                        <input type="range" id="progressSlider" min="0" max="100" step="5" value="${currentProgress}" 
                            style="width: 100%; height: 8px; cursor: pointer;"
                            oninput="document.getElementById('progressDisplay').textContent = this.value + '%'">
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;" class="text-xs text-muted">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                            <span>75%</span>
                            <span>100%</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; justify-content: center;">
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('progressSlider').value=0; document.getElementById('progressDisplay').textContent='0%';">0%</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('progressSlider').value=25; document.getElementById('progressDisplay').textContent='25%';">25%</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('progressSlider').value=50; document.getElementById('progressDisplay').textContent='50%';">50%</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('progressSlider').value=75; document.getElementById('progressDisplay').textContent='75%';">75%</button>
                            <button class="btn btn-primary btn-sm" onclick="document.getElementById('progressSlider').value=100; document.getElementById('progressDisplay').textContent='100%';">100% ‚úÖ</button>
                        </div>
                    </div>
                `,
                submitText: 'Save Progress',
                onSubmit: async () => {
                    const newProgress = parseInt(document.getElementById('progressSlider').value);
                    try {
                        const updateData = {
                            'data.progress': newProgress,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // Auto-complete if 100%
                        if (newProgress === 100) {
                            updateData['data.status'] = 'completed';
                            updateData['data.completedAt'] = firebase.firestore.FieldValue.serverTimestamp();
                        } else if (newProgress > 0) {
                            updateData['data.status'] = 'in-progress';
                        }

                        await db.collection('logs').doc(taskId).update(updateData);
                        Utils.showToast(`Progress updated to ${newProgress}%`, 'success');
                        await loadTasks();
                        applyFilters();
                    } catch (error) {
                        Utils.showToast('Error updating progress: ' + error.message, 'error');
                    }
                }
            });
        }

        async function createTask() {
            // Load users for assignment dropdown
            let userOptions = [{ value: 'all', label: 'üì¢ All Team Members' }];

            try {
                const usersSnap = await db.collection('users').get();
                const users = usersSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(u => u.isActive !== false);

                userOptions = [
                    { value: 'all', label: 'üì¢ All Team Members' },
                    ...users.map(u => ({
                        value: u.id,
                        label: `${u.name || u.email || 'Unknown'}`
                    }))
                ];
            } catch (error) {
                console.error('Error loading users:', error);
                Utils.showToast('Could not load users list', 'warning');
            }

            Modal.form({
                title: 'Create New Task',
                fields: [
                    { name: 'title', label: 'Task Title', type: 'text', required: true, placeholder: 'Enter task title...' },
                    { name: 'description', label: 'Description', type: 'textarea', placeholder: 'Describe the task...' },
                    {
                        name: 'priority', label: 'Priority', type: 'select', required: true, options: [
                            { value: 'high', label: 'High Priority' },
                            { value: 'medium', label: 'Medium Priority' },
                            { value: 'low', label: 'Low Priority' }
                        ]
                    },
                    {
                        name: 'assignee', label: 'Assign To', type: 'select', required: true, options: userOptions
                    },
                    { name: 'dueDate', label: 'Due Date (Optional)', type: 'date' }
                ],
                onSubmit: async (data) => {
                    try {
                        const taskData = {
                            title: data.title,
                            description: data.description || '',
                            priority: data.priority,
                            assignee: data.assignee,
                            dueDate: data.dueDate ? new Date(data.dueDate) : null,
                            status: 'pending',
                            progress: 0
                        };

                        await Firestore.assignTask(taskData);

                        // Send notifications to assignees
                        if (taskData.assignee === 'all') {
                            await Notifications.sendGlobal(
                                'New Task Assigned',
                                `New task "${taskData.title}" has been assigned to all team members`,
                                'task'
                            );
                        } else {
                            await Notifications.notifyTaskAssigned(taskData.title, taskData.assignee);
                        }

                        Utils.showToast('Task created successfully!', 'success');
                        await loadTasks();
                    } catch (error) {
                        Utils.showToast('Error creating task: ' + error.message, 'error');
                    }
                }
            });
        }

        function editTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            const data = task.data || {};

            Modal.form({
                title: 'Edit Task',
                fields: [
                    { name: 'title', label: 'Task Title', type: 'text', required: true, value: data.title || '' },
                    { name: 'description', label: 'Description', type: 'textarea', value: data.description || '' },
                    {
                        name: 'priority', label: 'Priority', type: 'select', required: true, value: data.priority || 'medium', options: [
                            { value: 'high', label: 'High Priority' },
                            { value: 'medium', label: 'Medium Priority' },
                            { value: 'low', label: 'Low Priority' }
                        ]
                    },
                    {
                        name: 'status', label: 'Status', type: 'select', required: true, value: data.status || 'pending', options: [
                            { value: 'pending', label: 'Pending' },
                            { value: 'in-progress', label: 'In Progress' },
                            { value: 'completed', label: 'Completed' }
                        ]
                    },
                    { name: 'progress', label: 'Progress (%)', type: 'number', value: data.progress || 0 }
                ],
                onSubmit: async (formData) => {
                    try {
                        const updateData = {
                            'data.title': formData.title,
                            'data.description': formData.description,
                            'data.priority': formData.priority,
                            'data.status': formData.status,
                            'data.progress': parseInt(formData.progress) || 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        if (formData.status === 'completed' && data.status !== 'completed') {
                            updateData['data.completedAt'] = firebase.firestore.FieldValue.serverTimestamp();
                            updateData['data.progress'] = 100;
                        }

                        await db.collection('logs').doc(taskId).update(updateData);
                        Utils.showToast('Task updated successfully!', 'success');
                        await loadTasks();
                        applyFilters();
                    } catch (error) {
                        Utils.showToast('Error updating task: ' + error.message, 'error');
                    }
                }
            });
        }

        async function deleteTask(taskId) {
            Modal.confirm('Delete this task permanently? This action cannot be undone.', async () => {
                try {
                    await db.collection('logs').doc(taskId).delete();
                    Utils.showToast('Task deleted successfully', 'success');
                    await loadTasks();
                    applyFilters();
                } catch (error) {
                    Utils.showToast('Error deleting task: ' + error.message, 'error');
                }
            });
        }

        Router.initPage();
    </script>
</body>

</html>