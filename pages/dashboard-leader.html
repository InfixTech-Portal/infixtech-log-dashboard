<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leader Dashboard | INFI X TECH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="header-container"></div>
            <div class="page-content">
                <div id="loadingState" class="text-center py-4">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <p class="text-muted">Loading command center...</p>
                </div>

                <div id="dashboardContent" style="display: none;">
                    <!-- Banner -->
                    <div class="card mb-lg"
                        style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none;">
                        <div class="card-body"
                            style="padding: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem;">Team Command
                                    Center üéØ</h1>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Manage your team, finances, and operations.
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="showExportOptions()">üìÑ Export Reports</button>
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="showAssignTaskModal()">+ Assign Task</button>
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="showCollectionModal()">üí∞ Collect</button>
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white;"
                                    onclick="showAnnouncementModal()">üì¢ Announce</button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;"
                        id="statsRow">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon primary">üë•</div>
                                <div>
                                    <div class="stat-value" id="memberCount">-</div>
                                    <div class="stat-label">Members</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon success">üèÜ</div>
                                <div>
                                    <div class="stat-value" id="eventCount">-</div>
                                    <div class="stat-label">Events</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon warning">‚úÖ</div>
                                <div>
                                    <div class="stat-value" id="taskProgress">-</div>
                                    <div class="stat-label">Tasks Done</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-icon info">üè¶</div>
                                <div>
                                    <div class="stat-value" id="balance">‚Çπ0</div>
                                    <div class="stat-label">Collected</div>
                                </div>
                            </div>
                        </div>
                        <div class="card" id="myDebtCard">
                            <div class="stat-card">
                                <div class="stat-icon danger">üí∏</div>
                                <div>
                                    <div class="stat-value" id="myDebt">-</div>
                                    <div class="stat-label">My Debt</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                        <!-- Left Column -->
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- Charts Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Task Distribution</h3>
                                    </div>
                                    <div class="card-body" style="height: 200px;"><canvas id="taskChart"></canvas></div>
                                </div>
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Collection Status</h3>
                                    </div>
                                    <div class="card-body" style="height: 200px;"><canvas id="collectionChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Recent Activity</h3>
                                    <span class="text-muted text-sm">Last 10 actions</span>
                                </div>
                                <div class="card-body" id="activityFeed" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-muted text-center py-4">Loading...</p>
                                </div>
                            </div>

                            <!-- Pending Approvals -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Pending Actions</h3>
                                </div>
                                <div class="card-body" id="pendingActions">
                                    <p class="text-muted text-center py-4">No pending actions</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- Quick Actions -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Quick Actions</h3>
                                </div>
                                <div class="card-body" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <button class="btn btn-secondary" style="justify-content: flex-start;"
                                        onclick="showAssignTaskModal()">‚úÖ Assign Task</button>
                                    <button class="btn btn-secondary" style="justify-content: flex-start;"
                                        onclick="showCollectionModal()">üí∞ Create Collection</button>
                                    <button class="btn btn-secondary" style="justify-content: flex-start;"
                                        onclick="showEventModal()">üèÜ Add Event</button>
                                    <a href="admin/members.html" class="btn btn-secondary"
                                        style="justify-content: flex-start;">üë• Manage Members</a>
                                    <a href="admin/transactions.html" class="btn btn-secondary"
                                        style="justify-content: flex-start;">üí≥ Transaction Manager</a>
                                    <a href="logs/task-logs.html" class="btn btn-secondary"
                                        style="justify-content: flex-start;">üìã View All Tasks</a>
                                    <button class="btn btn-primary" onclick="downloadReport()">üìÑ Download
                                        Report</button>
                                </div>
                            </div>

                            <!-- Team Preview -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Team Overview</h3><a href="admin/members.html"
                                        class="btn btn-ghost btn-sm">View All</a>
                                </div>
                                <div class="card-body" id="teamPreview" style="max-height: 250px; overflow-y: auto;">
                                    <p class="text-muted text-center py-4">Loading...</p>
                                </div>
                            </div>

                            <!-- Upcoming -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Upcoming</h3>
                                </div>
                                <div class="card-body" id="upcomingEvents">
                                    <p class="text-muted text-center py-4">No upcoming events</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LEADER FULL ACCESS SECTIONS -->
                    <div style="margin-top: 1.5rem;">
                        <!-- Section Tabs -->
                        <div class="card mb-lg">
                            <div class="card-body" style="display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 1rem;">
                                <button class="btn btn-primary" onclick="showSection('allLogs')" id="tabLogs">üìã All
                                    User Logs</button>
                                <button class="btn btn-secondary" onclick="showSection('allTasks')" id="tabTasks">‚úÖ All
                                    Tasks</button>
                                <button class="btn btn-secondary" onclick="showSection('allInventory')"
                                    id="tabInventory">üíª All Inventory</button>
                                <button class="btn btn-secondary" onclick="showSection('allIssues')" id="tabIssues">üêõ
                                    All Issues</button>
                                <button class="btn btn-secondary" onclick="showSection('allTransactions')"
                                    id="tabTransactions">üí∞ All Transactions</button>
                            </div>
                        </div>

                        <!-- All User Logs Section -->
                        <div class="card" id="sectionAllLogs">
                            <div class="card-header">
                                <h3 class="card-title">üìã All User Activity Logs</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select class="form-input" id="logUserFilter" style="max-width: 200px;">
                                        <option value="">All Users</option>
                                    </select>
                                    <select class="form-input" id="logTypeFilter" style="max-width: 150px;">
                                        <option value="">All Types</option>
                                        <option value="task">Tasks</option>
                                        <option value="payment">Payments</option>
                                        <option value="personal_note">Notes</option>
                                        <option value="event">Events</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body" id="allLogsContent" style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">Loading all logs...</p>
                            </div>
                        </div>

                        <!-- All Tasks Section -->
                        <div class="card" id="sectionAllTasks" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">‚úÖ All Team Tasks</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select class="form-input" id="taskStatusFilter" style="max-width: 150px;">
                                        <option value="">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                    <select class="form-input" id="taskUserFilter" style="max-width: 200px;">
                                        <option value="">All Users</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body" id="allTasksContent" style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">Loading all tasks...</p>
                            </div>
                        </div>

                        <!-- All Inventory Section -->
                        <div class="card" id="sectionAllInventory" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">üíª Hardware & Software Inventory</h3>
                                <button class="btn btn-ghost btn-sm" onclick="showAddDeviceModal()">+ Add
                                    Device</button>
                            </div>
                            <div class="card-body" id="allInventoryContent"
                                style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">Loading inventory...</p>
                            </div>
                        </div>

                        <!-- All Issues Section -->
                        <div class="card" id="sectionAllIssues" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">üêõ All Reported Issues</h3>
                                <select class="form-input" id="issueStatusFilter" style="max-width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="open">Open</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="card-body" id="allIssuesContent" style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">Loading issues...</p>
                            </div>
                        </div>

                        <!-- All Transactions Section -->
                        <div class="card" id="sectionAllTransactions" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title">üí∞ All Financial Transactions</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select class="form-input" id="transTypeFilter" style="max-width: 150px;">
                                        <option value="">All Types</option>
                                        <option value="credit">Income</option>
                                        <option value="debit">Expense</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body" id="allTransactionsContent"
                                style="max-height: 500px; overflow-y: auto;">
                                <p class="text-muted text-center py-4">Loading transactions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/firestore.js"></script>
    <script src="../js/components.js"></script>
    <script src="../js/reports.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/app.js"></script>

    <script>
        window.addEventListener('userDataLoaded', async (e) => {
            const user = e.detail;

            // Check leader access
            if (!user.roles?.includes('leader')) {
                Utils.showToast('Access denied. Leader role required.', 'error');
                setTimeout(() => window.location.href = `dashboard-${Auth.getPrimaryRole(user.roles)}.html`, 1500);
                return;
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            await loadDashboardData(user);
        });

        async function loadDashboardData(user) {
            try {
                // Parallel data loading - using simple queries to avoid composite indexes
                const [stats, finStatus, usersSnap, logsSnap, eventsSnap, collectionsSnap] = await Promise.all([
                    Firestore.getDashboardStats(),
                    Firestore.getUserFinancialStatus(user.uid),
                    db.collection('users').get(),
                    db.collection('logs').get(),
                    db.collection('events').get(),
                    db.collection('moneyCollections').get()
                ]);

                // Stats
                document.getElementById('memberCount').textContent = stats.activeMembers || 0;
                document.getElementById('eventCount').textContent = stats.activeEvents || 0;
                document.getElementById('taskProgress').textContent = `${stats.completed || 0}/${stats.total || 0}`;

                // Filter active collections client-side
                const activeCollections = collectionsSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(c => c.status === 'active');

                // Calculate total collected
                let totalCollected = 0;
                let totalPending = 0;
                activeCollections.forEach(c => {
                    c.assignedMembers?.forEach(m => {
                        if (m.status === 'paid') totalCollected += (m.amount || 0);
                        else totalPending += (m.amount || 0);
                    });
                });
                document.getElementById('balance').textContent = Utils.formatCurrency(totalCollected);
                document.getElementById('myDebt').textContent = Utils.formatCurrency(finStatus.outstandingAmount);

                if (finStatus.outstandingAmount === 0) {
                    document.getElementById('myDebtCard').querySelector('.stat-icon').className = 'stat-icon success';
                    document.getElementById('myDebtCard').querySelector('.stat-label').textContent = 'All Clear!';
                }

                // Task Chart
                new Chart(document.getElementById('taskChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{ data: [stats.completed || 0, (stats.total || 0) - (stats.completed || 0)], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12 } } } }
                });

                // Collection Chart
                new Chart(document.getElementById('collectionChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Collected', 'Pending'],
                        datasets: [{ data: [totalCollected, totalPending], backgroundColor: ['#6366f1', '#ef4444'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12 } } } }
                });

                // Team Preview
                const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('teamPreview').innerHTML = users.slice(0, 8).map(u => `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--bg-glass-border);">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--primary-500); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 600;">${(u.name || 'U').charAt(0)}</div>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${u.name || 'User'}</div>
                            <div class="text-xs text-muted">${(u.roles || ['member'])[0]}</div>
                        </div>
                        <span style="font-size: 0.7rem; color: ${u.isActive !== false ? 'var(--success-500)' : 'var(--text-muted)'};">‚óè</span>
                    </div>
                `).join('') || '<p class="text-muted text-center">No members</p>';

                // Activity Feed - sorted client-side
                const logs = logsSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => {
                        const aDate = a.createdAt?.toDate?.() || new Date(0);
                        const bDate = b.createdAt?.toDate?.() || new Date(0);
                        return bDate - aDate;
                    })
                    .slice(0, 10);
                document.getElementById('activityFeed').innerHTML = logs.map(log => {
                    const icons = { task: '‚úÖ', payment: 'üí∞', event: 'üèÜ', collection: 'üìù' };
                    return `
                        <div style="display: flex; gap: 1rem; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--bg-glass-border);">
                            <span style="font-size: 1.1rem;">${icons[log.type] || 'üìã'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${log.data?.title || log.type}</div>
                                <div class="text-xs text-muted">${Utils.timeAgo(log.createdAt)}</div>
                            </div>
                        </div>
                    `;
                }).join('') || '<p class="text-muted text-center py-4">No recent activity</p>';

                // Upcoming Events
                const events = eventsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('upcomingEvents').innerHTML = events.map(ev => `
                    <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--bg-glass-border);">
                        <div style="font-weight: 500;">${ev.name || 'Event'}</div>
                        <div class="text-xs text-muted">${ev.date ? Utils.formatDate(ev.date) : 'TBD'}</div>
                    </div>
                `).join('') || '<p class="text-muted text-center py-4">No upcoming events</p>';

            } catch (error) {
                console.error('Dashboard error:', error);
                Utils.showToast('Error loading dashboard data', 'error');
            }
        }

        // ===== MODAL FUNCTIONS =====
        function showAssignTaskModal() {
            Modal.form({
                title: 'Assign New Task',
                fields: [
                    { name: 'title', label: 'Task Title', placeholder: 'Enter task title...', required: true },
                    { name: 'description', label: 'Description', type: 'textarea', placeholder: 'Task details...' },
                    {
                        name: 'priority', label: 'Priority', type: 'select', options: [
                            { value: 'low', label: 'Low' },
                            { value: 'medium', label: 'Medium' },
                            { value: 'high', label: 'High' }
                        ]
                    },
                    {
                        name: 'assignee', label: 'Assign To', type: 'select', options: [
                            { value: 'all', label: 'All Members' }
                        ]
                    }
                ],
                onSubmit: async (data) => {
                    try {
                        await Firestore.assignTask(data);
                        Utils.showToast('Task assigned successfully!', 'success');
                        loadDashboardData(Auth.userData);
                    } catch (error) {
                        Utils.showToast('Error assigning task: ' + error.message, 'error');
                    }
                }
            });
        }

        function showCollectionModal() {
            Modal.form({
                title: 'Create Collection Request',
                fields: [
                    { name: 'title', label: 'Title / Reason', placeholder: 'e.g., Monthly Subscription', required: true },
                    { name: 'amount', label: 'Amount per Person (‚Çπ)', type: 'number', placeholder: '100', required: true },
                    { name: 'description', label: 'Description', type: 'textarea', placeholder: 'Additional details...' }
                ],
                onSubmit: async (data) => {
                    try {
                        await Firestore.createCollectionRequest({
                            title: data.title,
                            amount: Number(data.amount),
                            description: data.description,
                            assignedTo: 'all'
                        });
                        Utils.showToast('Collection request sent to all members!', 'success');
                        loadDashboardData(Auth.userData);
                    } catch (error) {
                        Utils.showToast('Error: ' + error.message, 'error');
                    }
                }
            });
        }

        function showEventModal() {
            Modal.form({
                title: 'Add New Event',
                fields: [
                    { name: 'name', label: 'Event Name', placeholder: 'e.g., Hackathon 2024', required: true },
                    { name: 'description', label: 'Description', type: 'textarea', placeholder: 'Event details...' },
                    { name: 'date', label: 'Date', type: 'date' },
                    {
                        name: 'status', label: 'Status', type: 'select', options: [
                            { value: 'upcoming', label: 'Upcoming' },
                            { value: 'active', label: 'Active' },
                            { value: 'completed', label: 'Completed' }
                        ]
                    }
                ],
                onSubmit: async (data) => {
                    try {
                        await db.collection('events').add({
                            ...data,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: Auth.userData?.uid
                        });
                        Utils.showToast('Event created!', 'success');
                        loadDashboardData(Auth.userData);
                    } catch (error) {
                        Utils.showToast('Error: ' + error.message, 'error');
                    }
                }
            });
        }

        function showAnnouncementModal() {
            Modal.form({
                title: 'Send Announcement',
                fields: [
                    { name: 'title', label: 'Title', placeholder: 'Announcement title...', required: true },
                    { name: 'message', label: 'Message', type: 'textarea', placeholder: 'Write your announcement...', required: true }
                ],
                onSubmit: async (data) => {
                    try {
                        await db.collection('announcements').add({
                            ...data,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: Auth.userData?.uid,
                            read: []
                        });
                        Utils.showToast('Announcement sent!', 'success');
                    } catch (error) {
                        Utils.showToast('Error: ' + error.message, 'error');
                    }
                }
            });
        }

        function showExportOptions() {
            Modal.show({
                title: 'Export Reports',
                content: `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="Reports.generateActivityReport(); Modal.close();">
                            üìã Activity Log Report
                        </button>
                        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="Reports.generateFinancialReport(); Modal.close();">
                            üí∞ Financial Report
                        </button>
                        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="Reports.generateTaskReport(); Modal.close();">
                            ‚úÖ Task Report
                        </button>
                        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="Reports.generateMemberReport(); Modal.close();">
                            üë• Team Member Report
                        </button>
                    </div>
                    <p class="text-muted text-sm mt-lg">Reports are generated as PDF files with complete, formatted data.</p>
                `,
                submitText: 'Close',
                cancelText: ''
            });
        }

        // ==========================================
        // LEADER FULL ACCESS FUNCTIONS
        // ==========================================

        let allUsersData = [];
        let allLogsData = [];
        let allTasksData = [];
        let allInventoryData = [];
        let allIssuesData = [];
        let allTransactionsData = [];

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('[id^="sectionAll"]').forEach(el => el.style.display = 'none');
            // Show selected section
            document.getElementById('section' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).style.display = 'block';

            // Update tabs
            document.querySelectorAll('[id^="tab"]').forEach(el => el.classList.remove('btn-primary'));
            document.querySelectorAll('[id^="tab"]').forEach(el => el.classList.add('btn-secondary'));
            const tabId = 'tab' + sectionId.replace('all', '');
            document.getElementById(tabId)?.classList.remove('btn-secondary');
            document.getElementById(tabId)?.classList.add('btn-primary');
        }

        async function loadLeaderFullAccessData() {
            try {
                // Load all users for filters
                const usersSnap = await db.collection('users').get();
                allUsersData = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Populate user filters
                const userOptions = allUsersData.map(u => `<option value="${u.id}">${u.name || u.email || 'Unknown'}</option>`).join('');
                document.getElementById('logUserFilter').innerHTML = '<option value="">All Users</option>' + userOptions;
                document.getElementById('taskUserFilter').innerHTML = '<option value="">All Users</option>' + userOptions;

                // Load all logs
                const logsSnap = await db.collection('logs').get();
                allLogsData = logsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
                renderAllLogs();

                // Load all tasks (filter from logs where type = task)
                allTasksData = allLogsData.filter(l => l.type === 'task');
                renderAllTasks();

                // Load all inventory
                const inventorySnap = await db.collection('inventory').get();
                allInventoryData = inventorySnap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAllInventory();

                // Load all issues
                const issuesSnap = await db.collection('issues').get();
                allIssuesData = issuesSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
                renderAllIssues();

                // Load all transactions
                const transSnap = await db.collection('transactions').get();
                allTransactionsData = transSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.date?.toDate?.() || 0) - (a.date?.toDate?.() || 0));
                renderAllTransactions();

            } catch (error) {
                console.error('Error loading leader data:', error);
            }
        }

        function getUserName(userId) {
            const user = allUsersData.find(u => u.id === userId);
            return user?.name || user?.email?.split('@')[0] || 'Unknown';
        }

        function renderAllLogs() {
            const userFilter = document.getElementById('logUserFilter').value;
            const typeFilter = document.getElementById('logTypeFilter').value;

            let filtered = allLogsData;
            if (userFilter) filtered = filtered.filter(l => l.createdBy === userFilter || l.data?.assignee === userFilter);
            if (typeFilter) filtered = filtered.filter(l => l.type === typeFilter);

            if (filtered.length === 0) {
                document.getElementById('allLogsContent').innerHTML = '<p class="text-muted text-center py-4">No logs found</p>';
                return;
            }

            document.getElementById('allLogsContent').innerHTML = filtered.slice(0, 50).map(log => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--bg-glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="padding: 0.2rem 0.5rem; background: var(--bg-glass); border-radius: 12px; font-size: 0.7rem; text-transform: uppercase;">${log.type || 'log'}</span>
                            <strong>${log.data?.title || log.title || 'Log Entry'}</strong>
                        </div>
                        <div class="text-sm text-muted" style="margin-top: 0.25rem;">
                            üë§ ${getUserName(log.createdBy || log.data?.assignee)} ‚Ä¢ ${Utils.timeAgo(log.createdAt)}
                        </div>
                        ${log.data?.description ? `<div class="text-sm" style="margin-top: 0.25rem; opacity: 0.8;">${Utils.truncate(log.data.description, 100)}</div>` : ''}
                    </div>
                    <div style="text-align: right;">
                        ${log.data?.status ? `<span class="badge ${log.data.status === 'completed' ? 'badge-success' : 'badge-warning'}">${log.data.status}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderAllTasks() {
            const statusFilter = document.getElementById('taskStatusFilter').value;
            const userFilter = document.getElementById('taskUserFilter').value;

            let filtered = allTasksData;
            if (statusFilter) filtered = filtered.filter(t => t.data?.status === statusFilter);
            if (userFilter) filtered = filtered.filter(t => t.data?.assignee === userFilter);

            if (filtered.length === 0) {
                document.getElementById('allTasksContent').innerHTML = '<p class="text-muted text-center py-4">No tasks found</p>';
                return;
            }

            document.getElementById('allTasksContent').innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--bg-glass-border);">
                            <th style="text-align: left; padding: 0.75rem;">Task</th>
                            <th style="text-align: left; padding: 0.75rem;">Assigned To</th>
                            <th style="text-align: center; padding: 0.75rem;">Priority</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(t => `
                            <tr style="border-bottom: 1px solid var(--bg-glass-border);">
                                <td style="padding: 0.75rem;">
                                    <div style="font-weight: 500;">${t.data?.title || 'Untitled'}</div>
                                    <div class="text-xs text-muted">${Utils.truncate(t.data?.description || '', 50)}</div>
                                </td>
                                <td style="padding: 0.75rem;">${t.data?.assigneeName || getUserName(t.data?.assignee)}</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <span class="badge ${t.data?.priority === 'high' ? 'badge-danger' : t.data?.priority === 'low' ? 'badge-success' : 'badge-warning'}">${t.data?.priority || 'medium'}</span>
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <span class="badge ${t.data?.status === 'completed' ? 'badge-success' : t.data?.status === 'in-progress' ? 'badge-info' : 'badge-warning'}">${t.data?.status || 'pending'}</span>
                                </td>
                                <td style="text-align: right; padding: 0.75rem; font-size: 0.85rem;">${Utils.timeAgo(t.createdAt)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAllInventory() {
            if (allInventoryData.length === 0) {
                document.getElementById('allInventoryContent').innerHTML = '<p class="text-muted text-center py-4">No inventory items</p>';
                return;
            }

            const typeIcons = { laptop: 'üíª', tablet: 'üì±', phone: 'üì±', accessory: 'üéß', camera: 'üì∑', other: 'üì¶' };

            document.getElementById('allInventoryContent').innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--bg-glass-border);">
                            <th style="text-align: left; padding: 0.75rem;">Device</th>
                            <th style="text-align: left; padding: 0.75rem;">Type</th>
                            <th style="text-align: left; padding: 0.75rem;">Serial #</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allInventoryData.map(item => `
                            <tr style="border-bottom: 1px solid var(--bg-glass-border);">
                                <td style="padding: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.25rem;">${typeIcons[item.type] || 'üì¶'}</span>
                                        <div>
                                            <div style="font-weight: 500;">${item.name || 'Unnamed'}</div>
                                            ${item.notes ? `<div class="text-xs text-muted">${Utils.truncate(item.notes, 30)}</div>` : ''}
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 0.75rem; text-transform: capitalize;">${item.type || 'other'}</td>
                                <td style="padding: 0.75rem; font-family: monospace;">${item.serialNumber || '-'}</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <span class="badge ${item.status === 'available' ? 'badge-success' : item.status === 'in-use' ? 'badge-info' : 'badge-warning'}">${item.status || 'available'}</span>
                                </td>
                                <td style="text-align: right; padding: 0.75rem;">
                                    <button class="btn btn-ghost btn-sm" onclick="deleteItem('inventory', '${item.id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderAllIssues() {
            const statusFilter = document.getElementById('issueStatusFilter').value;
            let filtered = allIssuesData;
            if (statusFilter) filtered = filtered.filter(i => i.status === statusFilter);

            if (filtered.length === 0) {
                document.getElementById('allIssuesContent').innerHTML = '<p class="text-muted text-center py-4">No issues found</p>';
                return;
            }

            document.getElementById('allIssuesContent').innerHTML = filtered.map(issue => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--bg-glass-border); border-left: 4px solid var(--${issue.priority === 'critical' ? 'danger' : issue.priority === 'high' ? 'warning' : 'info'}-500);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${issue.title || 'Untitled Issue'}</div>
                            <div class="text-sm text-muted" style="margin-top: 0.25rem;">
                                Reported by ${getUserName(issue.createdBy)} ‚Ä¢ ${Utils.timeAgo(issue.createdAt)}
                            </div>
                            ${issue.description ? `<div class="text-sm" style="margin-top: 0.5rem;">${Utils.truncate(issue.description, 150)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="badge ${issue.status === 'resolved' ? 'badge-success' : issue.status === 'in-progress' ? 'badge-info' : 'badge-warning'}">${issue.status || 'open'}</span>
                            <button class="btn btn-ghost btn-sm" onclick="updateIssueStatus('${issue.id}', '${issue.status}')">${issue.status === 'open' ? '‚ñ∂Ô∏è' : issue.status === 'in-progress' ? '‚úÖ' : '‚Ü©Ô∏è'}</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderAllTransactions() {
            const typeFilter = document.getElementById('transTypeFilter').value;
            let filtered = allTransactionsData;
            if (typeFilter) filtered = filtered.filter(t => t.type === typeFilter);

            if (filtered.length === 0) {
                document.getElementById('allTransactionsContent').innerHTML = '<p class="text-muted text-center py-4">No transactions found</p>';
                return;
            }

            let totalIncome = filtered.filter(t => t.type === 'credit').reduce((sum, t) => sum + (t.amount || 0), 0);
            let totalExpense = filtered.filter(t => t.type === 'debit').reduce((sum, t) => sum + (t.amount || 0), 0);

            document.getElementById('allTransactionsContent').innerHTML = `
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-glass); border-radius: 12px;">
                    <div style="flex: 1; text-align: center;">
                        <div class="text-success" style="font-size: 1.5rem; font-weight: 700;">+${Utils.formatCurrency(totalIncome)}</div>
                        <div class="text-muted text-sm">Total Income</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div class="text-danger" style="font-size: 1.5rem; font-weight: 700;">-${Utils.formatCurrency(totalExpense)}</div>
                        <div class="text-muted text-sm">Total Expense</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: ${totalIncome - totalExpense >= 0 ? 'var(--success-500)' : 'var(--danger-500)'}">
                            ${Utils.formatCurrency(totalIncome - totalExpense)}
                        </div>
                        <div class="text-muted text-sm">Net Balance</div>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--bg-glass-border);">
                            <th style="text-align: left; padding: 0.75rem;">Description</th>
                            <th style="text-align: left; padding: 0.75rem;">Category</th>
                            <th style="text-align: center; padding: 0.75rem;">Type</th>
                            <th style="text-align: right; padding: 0.75rem;">Amount</th>
                            <th style="text-align: right; padding: 0.75rem;">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(t => `
                            <tr style="border-bottom: 1px solid var(--bg-glass-border);">
                                <td style="padding: 0.75rem;">${t.description || 'Transaction'}</td>
                                <td style="padding: 0.75rem;">${t.category || 'General'}</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <span class="badge ${t.type === 'credit' ? 'badge-success' : 'badge-danger'}">${t.type === 'credit' ? 'Income' : 'Expense'}</span>
                                </td>
                                <td style="text-align: right; padding: 0.75rem; font-weight: 600; color: ${t.type === 'credit' ? 'var(--success-500)' : 'var(--danger-500)'}">
                                    ${t.type === 'credit' ? '+' : '-'}${Utils.formatCurrency(t.amount || 0)}
                                </td>
                                <td style="text-align: right; padding: 0.75rem; font-size: 0.85rem;">${t.date ? Utils.formatDate(t.date) : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function updateIssueStatus(issueId, currentStatus) {
            const newStatus = currentStatus === 'open' ? 'in-progress' : currentStatus === 'in-progress' ? 'resolved' : 'open';
            try {
                await db.collection('issues').doc(issueId).update({ status: newStatus });
                Utils.showToast(`Issue marked as ${newStatus}`, 'success');
                const issue = allIssuesData.find(i => i.id === issueId);
                if (issue) issue.status = newStatus;
                renderAllIssues();
            } catch (error) {
                Utils.showToast('Error updating issue', 'error');
            }
        }

        async function deleteItem(collection, itemId) {
            if (!confirm('Delete this item?')) return;
            try {
                await db.collection(collection).doc(itemId).delete();
                Utils.showToast('Item deleted', 'success');
                location.reload();
            } catch (error) {
                Utils.showToast('Error deleting item', 'error');
            }
        }

        // Add event listeners for filters
        document.getElementById('logUserFilter')?.addEventListener('change', renderAllLogs);
        document.getElementById('logTypeFilter')?.addEventListener('change', renderAllLogs);
        document.getElementById('taskStatusFilter')?.addEventListener('change', renderAllTasks);
        document.getElementById('taskUserFilter')?.addEventListener('change', renderAllTasks);
        document.getElementById('issueStatusFilter')?.addEventListener('change', renderAllIssues);
        document.getElementById('transTypeFilter')?.addEventListener('change', renderAllTransactions);

        // Call loadLeaderFullAccessData after initDashboard
        window.addEventListener('userDataLoaded', () => {
            loadLeaderFullAccessData();
        });


        Router.initPage();
    </script>
</body>

</html>